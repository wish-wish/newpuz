//(function(){
	//'use strict';
var puzs={"0201":"0110.2.2..-1.abnormity\n\
2112\n\
1122",
"0301":"000213000.3.3..-1.abnormity\n\
321213132\n\
122132133",
"0401":"0010304001040400.4.6..-1.2_2\n\
4312324121341423\n\
1133113322442244",
"0402":"0400200340020030.4.6..-1.abnormity\n\
3421214343121234\n\
1111233423342244",
"0501":"0402020003000005000203050.5.8..-1.abnormity\n\
3452125413421355134213254\n\
1333311153221552444522445",
"0601":"250001000004001500004600600000100046.6.12..-1.abnormity\n\
253461316254461523534612642135125346\n\
111111233556233556234456234456224466",
"0602":"003200000100520001600042005000002600.6.12..-1.2_3\n\
413256256134524361631542165423342615\n\
111222111222333444333444555666555666",
"0701":"0060100060001020000630007000650000101000300020700.7.15..-1.abnormity\n\
4365172563241727415633217645657432171562341423756\n\
1111111233557723355772345577234457623446662244666",
"0801":"0207301080500140000000707000000130000004040000000710050603026080.8.22..-1.abnormity\n\
5247361886537142412658737538426138612754648513272714853613726485\n\
1111111122255778222557782345567823455678334466783344667833446688",
"0802":"6000300100058000000450008070005452000806000810000003400010070008.8.22..-1.2_4\n\
6582347141358762271456838376215452417836362815477863421514576328\n\
1122334411223344112233441122334455667788556677885566778855667788",
"0901":"058704320700000005300000064900603002000010000400807003840000006200000008036508240.9.31..-1.3_3\n\
658794321714362895392185764987653412523419687461827953849231576275946138136578249\n\
111222333111222333111222333444555666444555666444555666777888999777888999777888999",
"0902":"000409000001003200070304090429000706000060000503000864050706030004900600000608000.9.29..-1.abnormity\n\
765489321681593247176324598429835716847162953593217864958746132234971685312658479\n\
122222222133333332133444444155555444155556666177766666177777788199998888199999888",
"0903":"900016300300000000004002000600009108038070940409500006000100800000000007007860005.9.27.1.236.3_3\n\
925716384361485279784932561672349158538671942419528736246157893853294617197863425\n\
111222333111222333111222333444555666444555666444555666777888999777888999777888999",
"1001":"000370000000791050000000240050080000004100508209A3543096010039000000100A0041000000080527000000078000.10.36..-1.abnormity\n\
A54379182686791A5234918A2436577862539A4167518249A3543796A1823926A874152A95416378431865279A12A4378569\n\
1111111111222222299A333322299A344667789A344667789A345567789A345567789A345567889A345567889A44556688AA",
"1002":"3005000046650030709000070000000A0165340700040060A0090300400080A9461050000000A0000206080039130000800A.10.40..-1.2_5\n\
3195872A46652A34789124671A95839A8165342778349261A5A95371426887A9461352567823A9144216A85739134259867A\n\
1122334455112233445511223344551122334455112233445566778899AA66778899AA66778899AA66778899AA66778899AA",
"1101":"00300000A00000678AB0007008906000B0600000A790078000004600A0002000700B10000025008B500000306000B042009000B2A3500000400000B00.11.43..-1.abnormity\n\
92345678AB1342678AB91575A8916432B165234BA7985789AB21463BA9312568744B17698325AA8B54719632617AB342589896B2A3514723418597BA6\n\
11223344555112233645758129336457781293364577812933645778129936457781299664577812996645AA812996644AA88BBBBBAAAA88BBBBBBAAA",
"1201":"003000000A0000C50460320074020A90608503807002061000080000900002900C8401600160A2300940000600008000087090050CA0CA0408B02096004103A0B800002000000700.12.62..-1.abnormity\n\
85376941CA2B9BC5846A327174123A9C6B85A3897B52461C6CA8517B9432529ABC847163B16CA238594749B6271385CA387B96251CA4CA5418B723962741C3A6B859162345C9A7B8\n\
111111111111222227799BBC222227799BBC244557799ABC244557799ABC344567789ABC344567789ABC334566889ABC334566889ABC33456688AABC33456688AABC33556688AACC",
"1202":"90070600C2010069A00050005003200800B02300000008A7004039BC0710000070010003C00010050000012045790A0036700000009C0C006007800500010003A600105C0020B00A.12.60..-1.3_4\n\
9487B63AC2517B69A8125C345AC3214879B62315C46B98A7A54839BC671269B27CA14583C73B1A852469812645793ACB367A82541B9CBCA46397812542915BC3A678185C9726B34A\n\
111222333444111222333444111222333444111222333444555666777888555666777888555666777888555666777888999AAABBBCCC999AAABBBCCC999AAABBBCCC999AAABBBCCC",
"1203":"007602A0350000000000000070B0200A0406400083C9000700A2B870510050019006A00CB00AC004100800830762CA00C0007A310005304050070C0900000000000000570B802900.12.62..-1.2_6\n\
897642AB35C1AB1C3548976271B92C5A84364A6583C9B2176CA2B873519457319426AB8CB52AC694137894831762CA5BC69B7A314825324851B76CA928C4A91576B313576B8C294A\n\
111111777777111111777777222222888888222222888888333333999999333333999999444444AAAAAA444444AAAAAA555555BBBBBB555555BBBBBB666666CCCCCC666666CCCCCC"}
var isLe = (function() {
    var buf = new ArrayBuffer(2);
    new DataView(buf).setInt16(0, 256, true);
    var edianflag = new Int16Array(buf)[0] === 256;
    var da=new Date();
    if (edianflag) {
        console.log(da+"litten edian");
    } else {
        console.log(da+"big edian");
    }
    return edianflag;
})();

var len=4;
var txt="拼命加载中....(如果等很久了请刷新试试！)";
var count=0;
var intid=0;
function showLoading()
{
    var loading=document.getElementById("loading");
	if(loading) loading.hidden=false;
    if(loading!=null&&!loading.hidden)
    {
        loading.innerHTML=txt.substr(0,len+1);
    }
    len++;
    var intval=100;
    if(len>=txt.length)
    {
        intval=1000;
    }
    len=len%txt.length;
    intid=setTimeout(function(){
        showLoading();
		count+=intval;
		if(count>6000){
			var close=document.getElementById("close");
			if(close)
				close.hidden=false;
		}else if(count>144000)
		{
			removeLoading();
			if(!loading.hidden)
			{				
				reStart();
			}
		}
    },intval);		    
}
showLoading();
    
var removeLoading=function(){
    var gd=document;//.getElementById("GameDiv");
    var loading=document.getElementById("loading");
    if(gd&&loading)
    {
        //gd.removeChild(loading);
        loading.hidden=true;
		clearTimeout(intid);
        console.log("removeLoading 1");
    }
}

var parseParams=function()
{
    var ps=[];
    var params
    if(window.location.search.startsWith('?'))
        params=window.location.search.substr(1).split("&");
    else
        params=window.location.search.substr(0).split("&");
    for(var i=0;i<params.length;i++)
    {
        var nv=params[i].split("=");
        ps.push(nv);
    }
    ps.sort((a,b)=>{

        return a[0].localeCompare(b[0]);
    });
    return ps;
}
var query=function(pname)
{
    let params=parseParams();
    for(let i=0;i<params.length;i++)
    {
        if(params[i][0]==pname)//puzzle
        {
            if(params[i][1].length>0)
            {
                let num=Number.parseInt(params[i][1]);
                return num;
            }
        }
    }
    return 0;
}

var toData=function(datastr)
{
    var arrData = new Uint16Array(datastr.length);
    for (var i = 0; i < datastr.length; i++) {
        arrData[i] = datastr.charCodeAt(i);
    }
    return arrData;
}
var dispSodoku=function(data)
{
    var str="";
    str="<table border='1'>";
    var a=data.split('.');
    let n=Math.sqrt(a[0].length);
    for(var i=0;i<n;i++)
    {
        str+="<tr>";
        for(var j=0;j<n;j++)
        {
            str+="<td>"+a[0][i*n+j]+"</td>";
        }
        str+="</tr>";
    }
    str+="</table>";
    return str;
}
var ctx;
var canvas;
var size=50;
var optionnum=13;
var puz=""    
//var offsetx=1.4;
//var offsety=1.4;    
var offsetx=0.02;
var offsety=0.02;
var offunx=0.1;
var offuny=0.1;
var num=7;
var cells=[]; 
var funs=[];
var gblock="";
var gpuzzle="";
var ganswer="";
var selectcell=null;
var blocks=[];    
var isLans=false;
var tick=0;
var isCheck=false;
var interid=0;
var started=false;
let timetxt="";
function adaptsize(awidth,aheight)
{    
    aheight*=0.93;
    let mins=awidth;
    let maxs=awidth;
    if(mins>aheight) mins=aheight;
    if(maxs<aheight) maxs=aheight;
    isLans=false;
    if(awidth>=aheight) isLans=true;
    let diff=maxs-mins;        
    let bordernb=1+offsetx+offunx;
    let borderna=bordernb;
    size=Math.floor(mins/(num+borderna));      
    let margin=2;
    let cw=m*mins/1000;
    cw=0;
    //if(diff>=(size*bordernb))
    if(diff>=(size))
    {        
        if(isLans)
        {
            canvas.width=size*(num+bordernb)+margin+cw;
            canvas.height=size*(num+borderna)+margin;
        }else
        {
            canvas.width=size*(num+borderna)+margin;//-8;
            canvas.height=size*(num+bordernb)+margin+cw;
        }                   
    }else
    {   
        //size=Math.floor((maxs-size*bordernb)/(num+borderna));              
        if(isLans)
        {                
            canvas.width=size*(num+bordernb)+margin+cw;
            canvas.height=size*(num+borderna)+margin;
        }
        else
        {
            canvas.width=size*(num+borderna)+margin;//-8;
            canvas.height=size*(num+bordernb)+margin+cw;
        }
    }    
    if(canvas.width>awidth) canvas.width=awidth;
    if(canvas.height>aheight) canvas.width=aheight;
}
var appendBolds=function(bolds,line)
{
    ctx.moveTo(line[0],line[1]);
    ctx.lineTo(line[2],line[3]);
    for(var i=0;i<bolds.length;i++)
    {
        if(bolds[i][0]-line[0]<0.0000001
            &&bolds[i][1]-line[1]<0.0000001
            &&bolds[i][2]-line[2]<0.0000001
            &&bolds[i][3]-line[3]<0.0000001)
            {
                bolds.push(line);
                return true;
            }
    }
    return false;
}
var drawLoading=function()
{
    ctx.lineWidth=1*canvas.height/1000;  
    ctx.font = size/5*Math.sqrt(num)/2+"px serif";
    //ctx.font="italic 35px 黑体";  
    ctx.strokeStyle="#000099";
    ctx.fillStyle="red";        
    ctx.textAlign="center";
    ctx.textBaseline="middle";        
    ctx.beginPath();
    var width=211*size/150*Math.sqrt(num);
    var height=99*size/150*Math.sqrt(num);
    var offset=canvas.width/2-width/2;
    
    // ctx.moveTo(0+offset,0+offset);
    // ctx.lineTo(width+offset,0+offset);        
    // ctx.lineTo(width+offset,height+offset);        
    // ctx.lineTo(0+offset,height+offset);        
    // ctx.lineTo(0+offset,0+offset);   
    drawRoundRect([[0+offset,0+offset],[width+offset,0+offset],[width+offset,height+offset],[0+offset,height+offset]])
    var fh=size/5/2;
    ctx.fillText(1,width/2+offset,0+offset+fh);
    ctx.fillText(2,width+offset-fh,height/2+offset);
    ctx.fillText(3,width/2+offset,height+offset-fh);        
    ctx.fillText(4,0+offset+fh,height/2+offset);
    var idx=Math.floor(Math.random()*2);
    var tips=['Loading Fight...','拼命加载中...'];
    ctx.fillText(tips[idx],width/2+offset,height/2+offset);
    ctx.closePath();
    ctx.stroke();
    //ctx.fill();
}

function drawRoundRect(points)
{
    let round=20*canvas.height/1000;
    ctx.beginPath();    
    ctx.moveTo(points[0][0]+round,points[0][1]);    
    ctx.lineTo(points[1][0]-round,points[1][1]);
    ctx.arc(points[0][0]+round,points[0][1]+round,round,1.5*Math.PI,Math.PI,true);
    
    ctx.moveTo(points[1][0],points[1][1]+round);
    ctx.lineTo(points[2][0],points[2][1]-round);
    ctx.arc(points[1][0]-round,points[1][1]+round,round,2*Math.PI,1.5*Math.PI,true);
    
    ctx.moveTo(points[2][0]-round,points[2][1]);
    ctx.lineTo(points[3][0]+round,points[3][1]);    
    ctx.arc(points[2][0]-round,points[2][1]-round,round,0.5*Math.PI,0.0*Math.PI,true);

    ctx.moveTo(points[0][0],points[0][1]+round);    
    ctx.lineTo(points[3][0],points[3][1]-round);
    
    ctx.moveTo(points[3][0],points[3][1]-round); 
    ctx.arc(points[3][0]+round,points[3][1]-round,round,1.0*Math.PI,0.5*Math.PI,true);
    ctx.closePath();
    // ctx.stroke();
}

var codes="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz@";
var funcodes="0000000000000000000000000000000000000000000000000000000000清新@";

var qryCode=function(val)
{    
    return codes[val];
}
var qryFuns=function(val)
{    
    return funcodes[funcodes.length-val-2];
}

var m=15;
var drawKodoku=function(puzzle,block)
{                
    gblock=block;
    gpuzzle=puzzle;
    ctx.lineWidth=1*canvas.height/1000;        
    var a=puzzle.split('.');
    num=Math.sqrt(a[0].length);
    puz=a[0];
    ctx.font = size/2+"px serif";
    //ctx.font="italic 35px 黑体";  
    ctx.strokeStyle="#000099";
    ctx.fillStyle="red";
    ctx.textAlign="center";
    ctx.textBaseline="middle";        
    ctx.beginPath();
    cells=[];
    for(var i=0;i<num;i++)
    {
        cells.push([]);
        for(var j=0;j<num;j++)
        {
            var val=a[0][i*num+j];
            var bid=block[i*num+j];                            
            //左下右上
            var b={minx:(i+offsetx)*size,miny:(j+offsety)*size,maxx:(i+1+offsetx)*size,maxy:(j+1+offsety)*size,value:val,bi:bid
                ,lines:[[(i+offsetx)*size,(j+offsety)*size,(i+offsetx)*size,(j+1+offsety)*size]
                    ,[(i+offsetx)*size,(j+1+offsety)*size,(i+1+offsetx)*size,(j+1+offsety)*size]
                    ,[(i+1+offsetx)*size,(j+1+offsety)*size,(i+1+offsetx)*size,(j+offsety)*size]
                    ,[(i+1+offsetx)*size,(j+offsety)*size,(i+offsetx)*size,(j+offsety)*size]],user:0,x:i,y:j};
            cells[i].push(b);            
            if(val!='0'){
                drawRect(b);
                ctx.fillText(val,(i+0.5+offsetx)*size,(j+0.5+offsety)*size);
            }
            else
            {
                drawRoundRct(b);
            }
        }
    }                        
    ctx.closePath();  
           
    ctx.stroke();  
    
    strokeFuns();
    storkeAlien(block);
}    

var refreshKodoku=function(puzzle,block)
{        
    gblock=block;
    gpuzzle=puzzle;
    ctx.lineWidth=1*canvas.height/1000;        
    var a=puzzle.split('.');
    num=Math.sqrt(a[0].length);
    puz=a[0];
    ctx.font = size/2+"px serif";
    //ctx.font="italic 35px 黑体";  
    ctx.strokeStyle="#000099";
    ctx.fillStyle="red";
    ctx.textAlign="center";
    ctx.textBaseline="middle";        
    ctx.beginPath();
    for(var i=0;i<num;i++)
    {
        for(var j=0;j<num;j++)
        {
            
            var b=cells[i][j];
            b.minx=(i+offsetx)*size;
            b.miny=(j+offsety)*size;
            b.maxx=(i+1+offsetx)*size;
            b.maxy=(j+1+offsety)*size;
            b.lines=[[(i+offsetx)*size,(j+offsety)*size,(i+offsetx)*size,(j+1+offsety)*size]
                    ,[(i+offsetx)*size,(j+1+offsety)*size,(i+1+offsetx)*size,(j+1+offsety)*size]
                    ,[(i+1+offsetx)*size,(j+1+offsety)*size,(i+1+offsetx)*size,(j+offsety)*size]
                    ,[(i+1+offsetx)*size,(j+offsety)*size,(i+offsetx)*size,(j+offsety)*size]];            
            if(val!='0'){
                drawRect(b);
                ctx.fillText(val,(i+0.5+offsetx)*size,(j+0.5+offsety)*size);
            }
            else
            {
                drawRoundRct(b);
            }
        }
    }                        
    ctx.closePath();  
           
    ctx.stroke();  
    
    strokeFuns();
    storkeAlien(block);
}    

function drawRect(cell)
{
    ctx.moveTo(cell.lines[0][0],cell.lines[0][1]);
    ctx.lineTo(cell.lines[1][0],cell.lines[1][1]);                
    ctx.lineTo(cell.lines[2][0],cell.lines[2][1]);
    ctx.lineTo(cell.lines[3][0],cell.lines[3][1]);
    ctx.lineTo(cell.lines[0][0],cell.lines[0][1]);  
    ctx.closePath();
    ctx.stroke(); 
}

function drawRoundRct(cell)
{
    let round=20*canvas.height/1000;
    ctx.beginPath();    
    ctx.moveTo(cell.lines[0][0],cell.lines[0][1]+round);    
    ctx.lineTo(cell.lines[1][0],cell.lines[1][1]-round);
    
    ctx.moveTo(cell.lines[0][0],cell.lines[0][1]+round);
    ctx.arc(cell.lines[0][0]+round,cell.lines[0][1]+round,round,1.5*Math.PI,Math.PI,true);
    
    ctx.moveTo(cell.lines[1][0]+round,cell.lines[1][1]);
    ctx.lineTo(cell.lines[2][0]-round,cell.lines[2][1]);

    ctx.moveTo(cell.lines[1][0]+round,cell.lines[1][1]);
    ctx.arc(cell.lines[1][0]+round,cell.lines[1][1]-round,round,1.0*Math.PI,0.5*Math.PI,true);
    
    ctx.moveTo(cell.lines[2][0],cell.lines[2][1]-round);
    ctx.lineTo(cell.lines[3][0],cell.lines[3][1]+round);
    
    ctx.moveTo(cell.lines[2][0]-round,cell.lines[2][1]);
    ctx.lineTo(cell.lines[2][0],cell.lines[2][1]-round);    
    ctx.arc(cell.lines[2][0]-round,cell.lines[2][1]-round,round,0.5*Math.PI,0.0*Math.PI,true);

    ctx.moveTo(cell.lines[3][0]-round,cell.lines[3][1]);
    ctx.lineTo(cell.lines[0][0]+round,cell.lines[0][1]);
    
    ctx.moveTo(cell.lines[3][0]-round,cell.lines[3][1]); 
    ctx.arc(cell.lines[3][0]-round,cell.lines[3][1]+round,round,2.0*Math.PI,1.5*Math.PI,true);

    ctx.closePath();
    ctx.stroke();
}



function strokeFuns()
{
    funs=[];
    funs.push([]);
    ctx.beginPath();
    ctx.lineWidth=3*canvas.height/1000;
	ctx.font = size/2+"px serif";
    ctx.fillStyle="red";
    ctx.textAlign="center";
    let hpy=num+offsety+offuny; 
    let hpx=offsetx; 
    funs.push([]);        
    for(var i=0;i<num;i++)//bottom
    {
        ctx.moveTo((hpx+i)*size,(hpy)*size);
        ctx.lineTo((hpx+i)*size,(hpy+1)*size);
        ctx.lineTo((hpx+i+1)*size,(hpy+1)*size);
        ctx.lineTo((hpx+i+1)*size,(hpy)*size);
        ctx.lineTo((hpx+i)*size,(hpy)*size);          
        ctx.fillText(qryCode(i+1),(hpx+i+0.5)*size,(hpy+0.5)*size);
        var c={minx:(hpx+i)*size,miny:(hpy)*size,maxx:(hpx+i+1)*size,maxy:(hpy+1)*size,value:qryCode(i+1),color:"Red"};
        funs[funs.length-1].push(c);            
    }
    hpx=num+offsetx+offunx;
    hpy=offsety;
    funs.push([]);
    for(var i=0;i<num;i++)//right
    {
        ctx.moveTo((hpx)*size,(hpy+i)*size);
        ctx.lineTo((hpx)*size,(hpy+1+i)*size);
        ctx.lineTo((hpx+1)*size,(hpy+1+i)*size);
        ctx.lineTo((hpx+1)*size,(hpy+i)*size);
        ctx.lineTo((hpx)*size,(hpy+i)*size);  
        
        ctx.fillText(qryFuns(i),(hpx+0.5)*size,(hpy+i+0.5)*size);            
        var c={minx:(hpx)*size,miny:(hpy+i)*size,maxx:(hpx+1)*size,maxy:(hpy+i+1)*size,value:qryFuns(i),color:"Red"};
        //ctx.fillText(qryCode(i+1),(hpx+0.5)*size,(hpy+i+0.5)*size);            
        //var c={minx:(hpx)*size,miny:(hpy+i)*size,maxx:(hpx+1)*size,maxy:(hpy+i+1)*size,value:qryCode(i+1)};
        funs[funs.length-1].push(c);
    }    
    
    //corner        
    hpy+=offuny+num;
    ctx.moveTo((hpx)*size,(hpy)*size);
    ctx.lineTo((hpx)*size,(hpy+1)*size);
    ctx.lineTo((hpx+1)*size,(hpy+1)*size);
    ctx.lineTo((hpx+1)*size,(hpy)*size);
    ctx.lineTo((hpx)*size,(hpy)*size);      
    ctx.fillText('0',(hpx+0.5)*size,(hpy+0.5)*size);            
    var c={minx:(hpx)*size,miny:(hpy)*size,maxx:(hpx+1)*size,maxy:(hpy+1)*size,value:'0'};
    funs[funs.length-1].push(c);
    
    /*                 
    hpy=offuny;
    hpx=offsetx;        
    for(var i=0;i<num;i++)//top
    {
        ctx.moveTo((hpx+i)*size,(hpy)*size);
        ctx.lineTo((hpx+i)*size,(hpy+1)*size);
        ctx.lineTo((hpx+i+1)*size,(hpy+1)*size);
        ctx.lineTo((hpx+i+1)*size,(hpy)*size);
        ctx.lineTo((hpx+i)*size,(hpy)*size);  
        var c={minx:(hpx+i)*size,miny:(hpy)*size,maxx:(hpx+i+1)*size,maxy:(hpy+1)*size,value:''};
        funs[funs.length-1].push(c);
    }              
    
    hpy=offsety;
    hpx=offunx;
    funs.push([]);
    for(var i=0;i<num;i++)//left
    {
        ctx.moveTo((hpx)*size,(hpy+i)*size);
        ctx.lineTo((hpx)*size,(hpy+i+1)*size);
        ctx.lineTo((hpx+1)*size,(hpy+i+1)*size);
        ctx.lineTo((hpx+1)*size,(hpy+i)*size);
        ctx.lineTo((hpx)*size,(hpy+i)*size); 
        var c={minx:(hpx)*size,miny:(hpy+i)*size,maxx:(hpx+1)*size,maxy:(hpy+i+1)*size,value:0};
        funs[funs.length-1].push(c);            
    }
    */            
    ctx.closePath();        
    ctx.stroke();        
}

function drawTimeTxt(txt)
{
    ctx.fillStyle="#00ffff";
    let si=Math.floor(30*canvas.height/1000);
    let clamp=si;
    if(si<10) si=10;
    if(si>30) si=30;
    ctx.font = si+"px serif";    
    ctx.textAlign="start";    
    if(clamp>20) clamp=20;
    let atimetxt=timetxt+"["+txt+"].dev:cclin";
    let m=ctx.measureText(atimetxt)
    let h=canvas.height-m.fontBoundingBoxAscent
    ctx.clearRect(m.fontBoundingBoxDescent*0.5,h-m.fontBoundingBoxAscent/2-2,canvas.width,h);
    ctx.fillText(atimetxt,m.fontBoundingBoxDescent*0.5,h);
    ctx.stroke();
    return m.fontBoundingBoxAscent*1.2;
}

function storkeAlien(block)
{
    var bolds=[];
    ctx.lineWidth=7*canvas.height/1000;
    //ctx.lineStyle="red";
    ctx.beginPath();        
    for(var i=0;i<num;i++)
    {                
        for(var j=0;j<num;j++)
        {                    
            var idx=i*num+j;
            if(i<num-1)
            {
                var idx1=(i+1)*num+j;
                if(block[idx]!=block[idx1])
                {                            
                    appendBolds(bolds,cells[i][j].lines[2]);                        
                }
            }
            if(j<num-1)
            {
                var idx2=(i*num)+j+1;
                if(block[idx]!=block[idx2])
                {                            
                    appendBolds(bolds,cells[i][j].lines[1]);
                }
            }                    
            if(i==0)
            {
                appendBolds(bolds,cells[i][j].lines[0]);
            }
            if(j==0)
            {
                appendBolds(bolds,cells[i][j].lines[3]);                        
            }
            if(i==num-1)
            {
                appendBolds(bolds,cells[i][j].lines[2]);
            }
            if(j==num-1)
            {
                appendBolds(bolds,cells[i][j].lines[1]);
            }
        }
    }              
    started=true; 
    
    ctx.closePath();        
    ctx.stroke();
}
function drawFillCell(cell,color="green")
{
    var path=new Path2D();
    ctx.lineWidth=1*canvas.height/1000;    
    path.moveTo(cell.lines[0][0],cell.lines[0][1]);
    path.lineTo(cell.lines[0][2],cell.lines[0][3]);
    path.lineTo(cell.lines[1][2],cell.lines[1][3]);
    path.lineTo(cell.lines[2][2],cell.lines[2][3]);
    path.lineTo(cell.lines[3][2],cell.lines[3][3]);    
    path.closePath();        
    ctx.fillStyle=color;        
    ctx.fill(path);
    ctx.stroke(path);        
    if(cell.value>0)
    {
        drawRect(cell);
    }else
    {
        drawRoundRct(cell);
    }
}
function drawPathCell(cell)
{
    var path=new Path2D();  
    ctx.lineWidth=1*canvas.height/1000;
    path.moveTo(cell.lines[0][0],cell.lines[0][1]);
    path.lineTo(cell.lines[0][2],cell.lines[0][3]);
    path.lineTo(cell.lines[1][2],cell.lines[1][3]);
    path.lineTo(cell.lines[2][2],cell.lines[2][3]);
    path.lineTo(cell.lines[3][2],cell.lines[3][3]);    
    path.closePath();        
    ctx.strokeStyle="blue";        
    ctx.stroke(path);        
    if(cell.value>0)
    {
        drawRect(cell);
    }else
    {
        drawRoundRct(cell);
    }
}       
function fillTexts(isStroke=false)
{        
    for(let i=0;i<num;i++)
    {
        for(let j=0;j<num;j++)
        {
            if(codes.indexOf(cells[i][j].value)>0)
            {
                fillText(cells[i][j]);
            }
        }
    }        
}    
strokeidx=0;
strokeColors=["blue","0ff0ff"];
fillColors=["green","00ff00"];
function fillText(cell,isStroke=false)
{
    ctx.beginPath();
    ctx.font = size/2+"px serif";
    ctx.strokeStyle="blue"; 
    ctx.textAlign="center";
    if(codes.indexOf(cell.value)>0)
    {
        if(isStroke||cell.user==1||cell.user==2)
        {
            ctx.fillStyle=fillColors[cell.user-1];
            ctx.strokeStyle=strokeColors[cell.user-1];
            ctx.fillText(cell.value,cell.lines[0][0]+0.5*size,cell.lines[0][1]+0.5*size);
            ctx.strokeText(cell.value,cell.lines[0][0]+0.5*size,cell.lines[0][1]+0.5*size);
        }
        else
        {
            ctx.fillStyle="red";
            ctx.fillText(cell.value,cell.lines[0][0]+0.5*size,cell.lines[0][1]+0.5*size);
        }
    }
    ctx.closePath();
    ctx.stroke();
}
function drawSelect(cx,cy)
{
    ctx.clearRect(0,0,canvas.width,canvas.height);
    let hid=cells[cx][cy].bi;        
    for(let i=0;i<num;i++)
    {
        for(let j=0;j<num;j++)
        {
            if(i==cx)
            {
                drawFillCell(cells[i][j]);
            }
            if(j==cy)
            {
                drawFillCell(cells[i][j]);
            }
            if(hid==cells[i][j].bi)
            {                    
                drawFillCell(cells[i][j]);
            }
            else
            {
                drawPathCell(cells[i][j]);
            }
            
        }
    }
    drawFillCell(cells[cx][cy],"yellow");
    storkeAlien(gblock);
    strokeFuns();
    fillTexts();
}
function amouseout(e)
{
    //console.log(e);
}
function amouseover(e)
{
    //console.log(e);
}
function adrop(e)
{
    console.log(e);
}
function adragenter(e)
{
    console.log(e);
}
function apaste(e)
{
    console.log(e);
}
function akeydown(e)
{
    console.log(e);
}
function akeyup(e)
{
    console.log(e);
}    
function qryHitCells(posx,posy)
{
    for(var i=0;i<num;i++)
    {
        for(var j=0;j<num;j++)
        {
            if(posx>cells[i][j].minx&&posx<cells[i][j].maxx&&posy<cells[i][j].maxy&&posy>cells[i][j].miny)
            {
                return [0,i,j];
            }
        }
    }
    for(var i=0;i<funs.length;i++)
    {
        for(var j=0;j<funs[i].length;j++)
        {
            if(posx>funs[i][j].minx&&posx<funs[i][j].maxx&&posy<funs[i][j].maxy&&posy>funs[i][j].miny)
            {
                return [1,i,j];
            }
        }
    }
    return [-1,0,0];
}
function getBlock(bi)
{
    for(var i=0;i<blocks.length;i++)
    {
        if(blocks[i].bi==bi)
        {
            return blocks[i];
        }
    }
    return null;
}
function getGroups()
{
    blocks=[];
    for(var i=0;i<gblock.length;i++)
    {
        var x=Math.floor(i/num);
        var y=i%num;
        var blo=getBlock(gblock[i]);
        if(blo!=null)
        {
            blo.cells.push(cells[x][y]);
        }
        else
        {                
            var group={bi:gblock[i],cells:[]};
            blocks.push(group);
            group.cells.push(cells[x][y]);
        }
    }
    return blocks;
}
function bigger(i,j,val)
{
    if(codes.indexOf(cells[i][j].value)>0)
    {
        return true;
    }
    return false;
}
function checkSuccess()
{        
    var ret=true,ret1=true,ret2=true;
    var vals=[],vals1=[],vals2=[];
    var unsuccs=[];
    for(var i=0;i<num;i++)
    {            
        vals=[];
        //floor
        for(var j=0;j<num;j++)
        {
            if(vals.indexOf(cells[i][j].value)>=0)
            {
                ret=false;
                unsuccs.push({x:i,y:j,value:cells[i][j].value});
                break;
            }
            if(bigger(i,j,0))
            {
                vals.push(cells[i][j].value);                
            }
        }
        if(!ret||vals.length<num) break;
        if(ret&&vals.length==num)
        {            
            vals1=[];
            //tower
            for(var j=0;j<num;j++)
            {
                if(vals1.indexOf(cells[j][i].value)>=0)
                {
                    ret1=false;
                    unsuccs.push({x:i,y:j,value:cells[i][j].value});
                    break;
                }
                if(bigger(i,j,0))
                {
                    vals1.push(cells[j][i].value);   
                }
            }
            if(!ret1||vals1.length<num) break;
        }
    }        
    if(ret1&&ret&&vals.length==num&&vals1.length==num)
    {
        getGroups();
        for(var i=0;i<blocks.length;i++)
        {
            vals2=[];
            for(var j=0;j<blocks[i].cells.length;j++)
            {
                if(vals2.indexOf(blocks[i].cells[j].value)>=0)
                {
                    ret2=false;
                    unsuccs.push({x:i,y:j,value:cells[i][j].value});
                    break;
                }
                if(codes.indexOf(blocks[i].cells[j].value)>0)
                {
                    vals2.push(blocks[i].cells[j].value);
                }
            }
            if(!ret2||vals2.length<num)
            {
                break;
            }
        }            
    }
    if(ret&&ret1&&ret2&&vals.length==num&&vals1.length==num&&vals2.length==num){        
        console.log("checkSuccess");
    }
    return ret&&ret1&&ret2&&vals.length==num&&vals1.length==num&&vals2.length==num&&cells.length==num;
}
function checkAnswer()
{
    var ret=true;
    for(var i=0;i<cells.length;i++)
    {
        for(var j=0;j<cells[i].length;j++)
        {
            if(cells[i][j].value!=ganswer[i*num+j])
            {
                ret=false;
                break;
            }
        }
        if(!ret) break;
    }
    if(ret&&cells.length>0){        
        console.log('checkAnswer');
    }
    return ret&&cells.length==num;
}
function reStart()
{
    started=false;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    document.getElementById("subject").innerText="";
    var puzinfo=document.getElementById("puzinfo");
    var span=document.getElementById("span");
    var select=document.getElementById("select");
    puzinfo.removeChild(span);            
    puzinfo.removeChild(select);
    drawLoading();
    setTimeout(function(){            
        sockeRequect(num);
    },1000);        
}

function hasLevelUser()
{
    for(var i=0;i<num;i++)
    {
        for(var j=0;j<num;j++)
        {
            if(cells[i][j].user==strokeColors.length-1&&cells[i][j].value>0)
            {
                return true;
            }
        }
    }
    return false;
}

function amousedown(e)
{
    //PointerEvent,鼠标，手指触摸，触摸笔，多点触控，压感
    //MouseEvent，鼠标
    //TouchEvent，移动
    
    //通过style会被拉伸
            
    //console.log(e,canvas);        
            
    var posx=e.pageX-canvas.offsetLeft;
    var posy=e.pageY-canvas.offsetTop;        
    //console.log(cells[0][0],cells[6][6],posx,posy);
    //console.log(posx,posy,window);
    var hits=qryHitCells(posx,posy);
    if(hits[0]==0)
    {
        //console.log(puz[hits[1]*num+hits[2]]);
        drawSelect(hits[1],hits[2]);
        selectcell=cells[hits[1]][hits[2]];                       
    }
    else if(hits[0]==1)
    {
        //console.log(funs[hits[1]][hits[2]].value);
        if(selectcell&&funs[hits[1]][hits[2]].value<num+1)
        {
            var val=parseInt(funs[hits[1]][hits[2]].value);
            if(codes.indexOf(selectcell.value)>0&&selectcell.user)
            {
                selectcell.value=funs[hits[1]][hits[2]].value;
                selectcell.user=1+strokeidx;
                //fillText(selectcell,true);
                drawSelect(selectcell.x,selectcell.y);
                //fillTexts();
            }else if(codes.indexOf(selectcell.value)==0)
            {
                selectcell.value=funs[hits[1]][hits[2]].value;
                selectcell.user=1+strokeidx;
                //fillText(selectcell,true);
                drawSelect(selectcell.x,selectcell.y);
            }        
        }
        else if(funs[hits[1]][hits[2]].value=='清')
        {
            for(var i=0;i<cells.length;i++)
            {
                for(var j=0;j<cells[i].length;j++)
                {
                    if(hasLevelUser()&&cells[i][j].user==strokeColors.length-1)
                    {
                        cells[i][j].value=0;
                    }
                }
            }
            drawSelect(selectcell.x,selectcell.y);
        }
        else if(funs[hits[1]][hits[2]].value=='新')
        {
            reStart();
        }
        else if(funs[hits[1]][hits[2]].value=='格'||funs[hits[1]][hits[2]].value=='啶'||funs[hits[1]][hits[2]].value=='存')
        {            
            strokeidx=(strokeidx+1)%strokeColors.length;
        }
        else if(funs[hits[1]][hits[2]].value==num+1)
        {
            if(checkAnswer())
            {                                       
                reStart();
            }
        }
    }        
    /*
    ctx.beginPath();        
    ctx.moveTo(posx,posy);
    ctx.lineTo(posx,posy+0.3*size);
    ctx.lineTo(0.3*size+posx,posy+0.3*size);
    ctx.lineTo(0.3*size+posx,posy);
    ctx.lineTo(posx,posy);        
    ctx.closePath();        
    ctx.stroke();
    */
}
function amousemove(e)
{
    //console.log(e);
}
function amouseup(e)
{
    //console.log(e);
}
function awheel(e)
{
    console.log(e);
}   
function fmtStr(val,len)
{
    var l=(val+"").length;
    if(l<len)
    {
        for(i=l;i<len;i++)
        {
            val="0"+val;
        }
    }
    return val;
}
function startTimer()
{
    let uset=Date.now()-tick;
        
    let dat=new Date();        
    let titxt=
        //dat.getFullYear()+"/"+fmtStr((dat.getMonth()+1),2)+"/"+fmtStr(dat.getDate(),2)+" "+
        fmtStr(dat.getHours(),2)+":"+fmtStr(dat.getMinutes(),2)+":"+fmtStr(dat.getSeconds(),2)
        +":"+fmtStr(dat.getMilliseconds(),3);    
    let minis=uset%1000;
    let second=Math.floor(uset/1000);
    let minute=Math.floor(second/60);
    let hour=Math.floor(minute/60);
    let spand=fmtStr(hour,3)+":"+fmtStr(minute%60,2)+":"+fmtStr(second%60,2);
    //var span=document.getElementById("span");    
    //if(span) span.innerHTML=titxt+"--"+spand+"  cc";
    if(started)
    {
        strokeFuns();
        drawTimeTxt(titxt+".in."+spand);    
    }else
    {
        timetxt=fmtStr(dat.getFullYear(),4)+"/"+fmtStr((dat.getMonth()+1),2)+"/"+fmtStr(dat.getDate(),2)
        +" "+fmtStr(dat.getHours(),2)+":"+fmtStr(dat.getMinutes(),2)+":"+fmtStr(dat.getSeconds(),2)+":"
        +fmtStr(dat.getMilliseconds(),2);
    }
    setTimeout(function(){
        startTimer();        
    },200);
}


function startKodo(puz,ans,house)
{
    ganswer=ans;
    gpuzzle=puz;
    gblock=house; 
    var subj=document.getElementById("subject");
    //subj.style="font-size:xxx-small";
    subj.innerText=puz+"\n"+ans+"\n"+house;	
    let dat=new Date();    
    removeLoading();
    initSelect();
    strokeidx=0;
    adaptsize(window.visualViewport.width,window.visualViewport.height);
    ctx.clearRect(0,0,canvas.width,canvas.height);            
    drawKodoku(puz,house);
    isCheck=false;		
    //console.log("recv:"+str.length);     
    clearInterval(interid);
    interid=setInterval(function(){
        var issucc=(checkAnswer()||checkSuccess());
        if(!isCheck&&issucc)
        {      
            isCheck=true;
            reStart();
        }
    },2000);
}

function startLocal(num=0)
{   
    //for(let key of puzs){};
    //for(let key in puzs){};
    //Object.keys(puzs).forEach(key =>{});
    //Object.entries(puzs).forEach(item => console.log(item[0], item[1]))
    //Object.getOwnPropertyNames(puzs).forEach(key => console.log(key, puzs[key]))
    //Object.getOwnPropertySymbols(puzs).forEach(key => console.log(key, puzs[key]))
    //Reflect.ownKeys(puzs).forEach(key => console.log(key, puzs[key]))
    var idx=7;
    var key=Object.keys(puzs)[idx];
    if(num==0)
    {
        idx=Math.floor(Math.random()*Object.keys(puzs).length);
        key=Object.keys(puzs)[idx];
        num=parseInt(key.substring(0,2));
    }
    else
    {
        if(num==99) num=9;
        Object.keys(puzs).forEach(akey =>{
            var n=parseInt(akey.substring(0,2));
            if(num==n)
            {
                key=akey;
            }
        });
    }    
    var puz=puzs[key].split('\n');
    startKodo(puz[0],puz[1],puz[2]);
    //console.log(puz);
}

function sockeRequect(anum)
{        
    started=false;
    var addr="ws://www.5icoin.com:9818";
    if(window.location.href.startsWith("https://"))
        addr="wss://www.5icoin.com:9817";
    let socket=new WebSocket(addr); 
    try {        
        socket.binaryType = "arraybuffer";
        //new Date(year, monthIndex [, day [, hours [, minutes [, seconds [, milliseconds]]]]]);
        tick=Date.now();
        startTimer();
        socket.onopen = function(evt) {
            var str="rubric:num:"+anum+":0";
            //var str="rubric:num:99:0";
            socket.send(toData(str));
        };
        socket.onmessage = function(evt) {              
            var array = new Uint8Array(evt.data);
            var str = "";
            for (var i = 0; i < array.length; i++) {
                str = str + String.fromCharCode(array[i]);
            }
            var subject=str.split(":");                        
            startKodo(subject[3],subject[1],subject[5]);
            
            socket.close();            
        };
        socket.onerror = function(evt) {
            console.log("error:"+evt);
            socket.close();
            // var n=Math.floor(Math.random()*12);
            // if(n<2) n=2;
            // num=n;
            startLocal(anum);            
        };
        socket.onclose = function(evt) {
            socket.close();
        };    
    } catch (error) {
        console.log(error);
        // var n=Math.floor(Math.random()*12);
        // if(n<2) n=2;
        // num=n;
        startLocal(anum);                
    }    
}

var addSelects=function(select,num)
{
    var sel="<select id='select'>"
    if(num>=optionnum)num=optionnum-1;
    for(var i=2;i<optionnum;i++)
    {        
        if(i==num)
            sel+="<option value="+i+" selected='selected'>Size="+i+"</option>"    
        else
            sel+="<option value="+i+">Size="+i+"</option>"
    }
    sel+="<option value=99>Size=99</option>"
    sel+="</select>"
    select.innerHTML=sel;
}

window.onresize=function(e)
{
    //console.log(e.currentTarget.innerWidth,e.currentTarget.innerHeight,e.srcElement.innerWidth
    //,e.srcElement.innerHeight,e.target.innerWidth,e.target.innerHeight,window);
    //canvas.width=e.target.innerWidth;
    //canvas.height=e.target.innerHeight;
    adaptsize(e.currentTarget.innerWidth,e.currentTarget.innerHeight);
    ctx.clearRect(0,0,canvas.width,canvas.height);                        
    refreshKodoku(gpuzzle,gblock);    
}
function refresh()
{
    //todo:刷新无法画Loading
    const oldWidth = canvas.current.width;
    const oldHeight = canvas.current.height;
    // 先隐藏canvas
    canvas.current.style.display = 'none';
    const ctx = canvas.current.getContext('2d');
    // 保存canvas设置，清楚画布区域
    ctx?.save();
    ctx?.setTransform(1, 0, 0, 1, 0, 0);
    ctx?.clearRect(0, 0, oldWidth, oldHeight);
    // 还原canvas设置
    ctx?.restore();
    canvas.current.style.display = '';
}
function initSelect()
{
    var span=document.createElement('span');
    span.innerText="Change Size of Sudoku:";
    var select=document.createElement('select'); 
    select.id="select";
    span.id="span";
    var puzinfo=document.getElementById("puzinfo");
    select.style="font-size:x-large";
    //addSelects(select,7);        
    select.addEventListener("change",(e)=>{
        isCheck=true;
        console.log(select.value);
        document.getElementById("subject").innerText="";            
        //ctx.clearRect(0,0,canvas.width,canvas.height);
        num=parseInt(select.value);
        sockeRequect(num); 
        if(num==99) num=9;            
        showLoading();
        adaptsize(window.visualViewport.width,window.visualViewport.height);                     
        puzinfo.removeChild(span);            
        puzinfo.removeChild(select);
        drawLoading();
    });        
    var subj=document.getElementById("subject");        
    //subj.style="font-size:xxx-small";
    puzinfo.insertBefore(span,subj);
    puzinfo.insertBefore(select,subj);
    addSelects(select,num);         
}
function initKodo()
{                
    canvas.onselectstart = function (e) { return false; };		//for Chrome, disable text select while dragging        
    canvas.addEventListener('drop', adrop, false);
    canvas.addEventListener('dragenter', adragenter, false);

    // Key Listeners
    canvas.addEventListener('paste', apaste, false);
    canvas.addEventListener('keydown', akeydown, false);
    canvas.addEventListener('keyup', akeyup, false);
    
    // Mouse Interaction Listeners
    canvas.addEventListener('mouseout', amouseout, false);
    canvas.addEventListener('mouseover', amouseover, false);        
    canvas.addEventListener('mousedown', amousedown, false);
    canvas.addEventListener('mousemove', amousemove, false);
    canvas.addEventListener('mouseup', amouseup, false);
    canvas.addEventListener('wheel', awheel, false);
    
    canvas.addEventListener('pointerdown', (e)=>{ 
    
    }, false);
    canvas.addEventListener('pointermove',  (e)=>{ 
    
    }, false);        
    canvas.addEventListener('pointerup',  (e)=>{ 
    
    }, false);
    canvas.addEventListener('pointerleave', (e)=>{ 
    
    }, false);
    canvas.addEventListener('pointercancel', (e)=>{ 
    
    }, false);        
    
    canvas.addEventListener('mouseleave', (e)=>{ 
    
    }, false);
    
    canvas.addEventListener('touchstart', (e)=>{ 
    
    }, false);        
    canvas.addEventListener('touchmove', (e)=>{ 
    
    }, false);
    canvas.addEventListener('touchend', (e)=>{ 
    
    }, false);
    canvas.addEventListener('touchcancel', (e)=>{ 
    
    }, false);
    
    canvas.addEventListener('onresize', (e)=>{ 
        
    }, false);
                                         
    adaptsize(window.visualViewport.width,window.visualViewport.height);
    var alien=query("alien");
    sockeRequect(num);    
}

window.onload=function()
{        
    num=query("num")
    if(num<2)num=7;
    
    canvas=document.getElementById("sudoku");
    document.body.style="margin:0";
    ctx=canvas.getContext("2d"); 
    m=drawTimeTxt();
    adaptsize(window.visualViewport.width,window.visualViewport.height);   
       
    drawLoading();
    
    setTimeout(function(){
        initKodo();
    },300);        
}

// window.onload=function()
// {        
//     canvas=document.getElementById("sudoku");
//     document.body.style="margin:0";
//     ctx=canvas.getContext("2d"); 
    
//     //adaptsize(window.visualViewport.width,window.visualViewport.height);        
//     drawLoading();
     
// }
//})();